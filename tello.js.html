

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Source: tello.js | Ryze Tello NodeJS lib</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/bootstrap.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-jsdoc.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/tui-doc.css">

    
</head>
<body>
<nav class="lnb" id="lnb">
    <div class="logo" style="width: 300px; height: 66px">
        
            <a href="https://giwi.fr" rel="noopener noreferrer" target="_blank">
                <img src="http://www.giwi.fr/wp-content/uploads/2014/08/giwi.png" width="100%" height="100%">
            </a>
        
    </div>
    <div class="title">
        <h1><a href="index.html" class="link">Ryze Tello NodeJS lib</a></h1>
        
    </div>
    <div class="search-container" id="search-container">
        <input type="text" placeholder="Search">
        <ul></ul>
    </div>
    
        <ol class="lnb-tab">
            <li id="api-tab">
                <a href="#"><h4>API</h4></a>
            </li>
            <li id="examples-tab">
                <a href="#"><h4>Examples</h4></a>
            </li>
        </ol>
    
    <div class="lnb-examples hidden"><h3>Examples</h3><ul><li><a href="tutorial-Async-Await.html">With Async / Await</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="Async-Await_sub"></div></li><li><a href="tutorial-MockServer.html">With a mock server</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="MockServer_sub"></div></li><li><a href="tutorial-Promise.html">With Promises</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="Promise_sub"></div></li><li><a href="tutorial-Video_Stream.html">With Video Stream</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="Video_Stream_sub"></div></li></ul></div><div class="lnb-api hidden"><h3>Modules</h3><ul><li><a href="module-Tello.html">Tello</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:Tello_sub"></div></li></ul></div><div class="lnb-api hidden"><h3>Classes</h3><ul><li><a href="module-Tello-Tello.html">Tello</a><button type="button" class="hidden toggle-subnav btn btn-link">  <span class="glyphicon glyphicon-plus"></span></button><div class="hidden" id="module:Tello~Tello_sub"><div class="member-type">Methods</div><ul class="inner"><li><a href="module-Tello-Tello.html#backward">backward</a></li><li><a href="module-Tello-Tello.html#curve">curve</a></li><li><a href="module-Tello-Tello.html#down">down</a></li><li><a href="module-Tello-Tello.html#emergencyStop">emergencyStop</a></li><li><a href="module-Tello-Tello.html#flip">flip</a></li><li><a href="module-Tello-Tello.html#flyTo">flyTo</a></li><li><a href="module-Tello-Tello.html#forward">forward</a></li><li><a href="module-Tello-Tello.html#get">get</a></li><li><a href="module-Tello-Tello.html#land">land</a></li><li><a href="module-Tello-Tello.html#left">left</a></li><li><a href="module-Tello-Tello.html#listenState">listenState</a></li><li><a href="module-Tello-Tello.html#mock">mock</a></li><li><a href="module-Tello-Tello.html#right">right</a></li><li><a href="module-Tello-Tello.html#rotateCCW">rotateCCW</a></li><li><a href="module-Tello-Tello.html#rotateCW">rotateCW</a></li><li><a href="module-Tello-Tello.html#sendCmd">sendCmd</a></li><li><a href="module-Tello-Tello.html#sendMethod">sendMethod</a></li><li><a href="module-Tello-Tello.html#speed">speed</a></li><li><a href="module-Tello-Tello.html#start">start</a></li><li><a href="module-Tello-Tello.html#startStream">startStream</a></li><li><a href="module-Tello-Tello.html#stop">stop</a></li><li><a href="module-Tello-Tello.html#stopStream">stopStream</a></li><li><a href="module-Tello-Tello.html#takeoff">takeoff</a></li><li><a href="module-Tello-Tello.html#up">up</a></li><li><a href="module-Tello-Tello.html#wait">wait</a></li></ul></div></li></ul></div>
</nav>
<div id="resizer"></div>

<div class="main" id="main">
    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>'use strict';
const dgram = require('dgram');
const EventEmitter = require('events');
const PORT = 8889;
const HOST = '192.168.10.1';
const PORT2 = 8890;
const HOST2 = '0.0.0.0';
const localPort = 50602;
const {spawn} = require('child_process');

/**
 * @class Tello
 * @module Tello
 */
class Tello {
    /**
     *
     */
    constructor() {
        this.myEmitter = new EventEmitter();
        this.osdData = {};
        this.deviceIP = HOST;
        this.client = undefined;
        this.server = undefined;
        this.h264encoder = undefined;
    }

    /**
     *
     * @param {number} time in ms
     * @return {Promise&lt;Tello>}
     */
    async wait(time) {
        return new Promise(resolve => {
            setTimeout(() => {
                resolve(this);
            }, time);
        });
    };


    /**
     *
     * @return {Promise&lt;Tello>}
     */
    stopStream() {
        return new Promise(resolve => {
            this.sendCmd('streamoff').then(() => {
                if (this.tello_video) {
                    this.tello_video.close();
                    this.tello_video = undefined;
                }
                if (this.h264encoder) {
                    this.h264encoder.kill();
                }
                resolve(this)
            });
        });
    }

    /**
     *
     * @return {Promise&lt;Tello>}
     */
    startStream() {
        return new Promise(resolve => {
            this.sendCmd('streamon').then(() => {
                this.tello_video = dgram.createSocket('udp4');
                this.h264encoder_spawn = {
                    "command": 'mplayer',
                    "args": ['-gui', '-nolirc', '-fps', '35', '-really-quiet', '-']
                };
                this.h264encoder = spawn(this.h264encoder_spawn.command, this.h264encoder_spawn.args);
                this.h264encoder.on('close', (code) => {
                    console.log(`child process exited with code ${code}`);
                });
                this.h264encoder.stderr.on('data', data => {
                    console.log("mplayer error", data.toString());
                });
                this.tello_video.on('message', msg => this.h264encoder.stdin.write(msg));
                this.tello_video.on('listening', () => {
                    console.log(`tello_video listening ${this.tello_video.address().address}:${this.tello_video.address().port}`);
                    resolve(this)
                });
                this.tello_video.bind(11111, HOST2);
            });
        });
    }

    /**
     *
     * @return {Tello}
     */
    mock() {
        this.deviceIP = '127.0.0.1';
        return this;
    }

    /**
     *
     * @param {string} value
     * @return {Promise&lt;{tello: Tello, value: *}>}
     */
    get(value) {
        return Promise.resolve({value: this.osdData[value], tello: this});
    }

    /**
     *
     */
    listenState() {
        this.server.on('message', msg => {
            msg = msg.toString().trim();
            const fieldList = msg.split(';');
            fieldList.forEach(field => {
                const fields = field.split(':');
                this.osdData[fields[0]] = fields[1];
            });
            /*     console.log('fieldList', fieldList)
                 console.log('osdData', osdData)*/
        });

        this.server.on('listening', () => {
            const address = this.server.address();
            console.log('server listening', address.address, address.port);
        });
        this.server.bind(PORT2, HOST2);
    }

    /**
     *
     * @param {string} cmd
     * @return {Promise&lt;Tello>}
     */
    sendMethod(cmd) {
        return new Promise(((resolve, reject) => {
            const message = new Buffer(cmd);
            console.log('send:', cmd);
            this.client.send(message, 0, message.length, PORT, this.deviceIP, err => {
                if (err) {
                    reject(err);
                } else {
                    resolve(this)
                }
            });
        }));
    }

    /**
     *
     * @param {string} cmd
     * @return {Promise&lt;Tello>}
     */
    sendCmd(cmd) {
        return new Promise(((resolve, reject) => {
            this.sendMethod(cmd).then(() => {
                this.myEmitter.on('status', () => {
                    resolve(this);
                });
            }).catch(err => {
                reject(err);
            });
        }));
    }

    /**
     *
     * @return {Promise&lt;Tello>}
     */
    async emergencyStop() {
        return this.sendCmd('emergency');
    }

    /**
     *
     * @return {Promise&lt;Tello>}
     */
    takeoff() {
        return this.sendCmd('takeoff');
    }

    /**
     *
     * @param {number} x1 in cm
     * @param {number} y1 in cm
     * @param {number} z1 in cm
     * @param {number} x2 in cm
     * @param {number} y2 in cm
     * @param {number} z2 in cm
     * @param {number} speed in cm/s
     * @return {Promise&lt;Tello>}
     */
    curve(x1 = 20, y1 = 20, z1 = 20, x2 = 60, y2 = 40, z2 = 0, speed = 60) {
        return this.sendCmd('curve ' + x1 + ' ' + y1 + ' ' + z1 + ' ' + x2 + ' ' + y2 + ' ' + z2 + ' ' + speed + ' ');

    }

    /**
     *
     * @param {number} distance in cm
     * @return {Promise&lt;Tello>}
     */
    forward(distance = 50) {
        return this.sendCmd('forward ' + distance);
    }

    /**
     *
     * @return {Promise&lt;Tello>}
     */
    start() {
        return new Promise(resolve => {
            this.client = dgram.createSocket('udp4');
            this.server = dgram.createSocket('udp4');
            this.client.bind(localPort, '0.0.0.0', () => {
                console.log('connected');
                this.sendCmd('command').then(() => {
                    resolve(this);
                });
            });
            process.on('SIGINT', () => {
                this.stop();
            });
            this.client.on('message', msg => {
                if (msg.toString() === 'ok') {
                    console.log('Data received from server : ' + msg.toString());
                } else {
                    console.error('not ok', msg);
                }
                this.myEmitter.emit('status');
            });
            this.listenState();
        });
    }

    /**
     *
     * @param {number} distance in cm
     * @return {Promise&lt;Tello>}
     */
    right(distance = 50) {
        return this.sendCmd('right ' + distance);
    }

    /**
     *
     * @param {number} height in cm
     * @return {Promise&lt;Tello>}
     */
    down(height = 50) {
        return this.sendCmd('down ' + height);
    }

    /**
     *
     * @param {number} speed in cm/s
     * @return {Promise&lt;Tello>}
     */
    speed(speed = 50) {
        return this.sendCmd('speed ' + speed);
    }

    /**
     * Ends the process
     */
    stop() {
        this.client.close();
        this.server.close();
        if (this.tello_video) {
            this.tello_video.close();
        }
        if (this.h264encoder) {
            this.h264encoder.kill();
        }
        console.log('Goodbye !');
        process.exit();
    }

    /**
     *
     * @param {number} distance in cm
     * @return {Promise&lt;Tello>}
     */
    left(distance = 50) {
        return this.sendCmd('left ' + distance);
    }

    /**
     *
     * @param {number} angle in degree
     * @return {Promise&lt;Tello>}
     */
    rotateCW(angle = 90) {
        return this.sendCmd('cw ' + angle);
    }

    /**
     *
     * @return {Promise&lt;Tello>}
     */
    land() {
        return this.sendCmd('land');
    }

    /**
     *
     * @param {number} distance in cm
     * @return {Promise&lt;Tello>}
     */
    backward(distance = 50) {
        return this.sendCmd('back ' + distance);
    }

    /**
     *
     * @param {number} angle in degree
     * @return {Promise&lt;Tello>}
     */
    rotateCCW(angle = 90) {
        return this.sendCmd('ccw ' + angle);
    }

    /**
     *
     * @param {number} height in cm
     * @return {Promise&lt;Tello>}
     */
    up(height = 50) {
        return this.sendCmd('up ' + height);
    }

    /**
     *
     * @param {string} orientation values: f, b, l, r
     * @return {Promise&lt;Tello>}
     */
    flip(orientation = 'f') {
        return this.sendCmd('flip ' + orientation);
    }

    /**
     *
     * @param {number} x in cm
     * @param {number} y in cm
     * @param {number} z in cm
     * @param {number} speed in cm/s
     * @return {Promise&lt;Tello>}
     */
    flyTo(x = 50, y = 50, z = 0, speed = 100) {
        return this.sendCmd('go ' + x + ' ' + y + ' ' + z + ' ' + speed + ' ');
    }
}

module.exports = new Tello();</code></pre>
        </article>
    </section>




</div>

<footer>
    <img class="logo" src="http://www.giwi.fr/wp-content/uploads/2014/08/giwi.png" style="width: 300px; height: 66px">
    <div class="footer-text">Giwi Softwares</div>
</footer>
<script>prettyPrint();</script>
<script src="scripts/jquery.min.js"></script>
<script src="scripts/tui-doc.js"></script>
<script src="scripts/linenumber.js"></script>

    <script>
        var id = '_sub'.replace(/"/g, '_');
        var selectedApi = document.getElementById(id); // do not use jquery selector
        var $selectedApi = $(selectedApi);

        $selectedApi.removeClass('hidden');
        $selectedApi.parent().find('.glyphicon').removeClass('glyphicon-plus').addClass('glyphicon-minus');
        showLnbApi();
    </script>

</body>
</html>
